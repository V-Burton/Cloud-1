---
- name: Attendre que le port 3306 de la DB soit accessible
  shell: docker-compose run --rm --entrypoint sh wpcli -c 'nc -z -v -w5 db 3306'
  args:
    chdir: "{{ wordpress_project_dir }}"
  register: db_net_check
  until: db_net_check.rc == 0
  retries: 24
  delay: 5
  changed_when: false
  tags: wait_for_db

- name: Vérifier si WordPress est installé
  shell: docker-compose run --rm wpcli wp core is-installed
  args:
    chdir: "{{ wordpress_project_dir }}"
  register: wp_installed
  failed_when: false
  changed_when: false
  tags: check_wp_installed

- name: Installer le Core WordPress (si nécessaire)
  shell: |
    docker-compose run --rm wpcli wp core install \
      --url="{{ wp_url }}" \
      --title="{{ wp_title }}" \
      --admin_user="{{ wp_admin_user }}" \
      --admin_password="{{ wp_admin_password }}" \
      --admin_email="{{ wp_admin_email }}" \
      --skip-email
  args:
    chdir: "{{ wordpress_project_dir }}"
  when: wp_installed.rc != 0
  tags: install_core

- name: Créer l'utilisateur secondaire (si nécessaire)
  shell: |
    docker-compose run --rm wpcli wp user create \
      "{{ wp_user }}" "{{ wp_user_email }}" \
      --user_pass="{{ wp_user_password }}" \
      --role=editor
  args:
    chdir: "{{ wordpress_project_dir }}"
  register: create_user_cmd
  changed_when: "'Created user' in create_user_cmd.stdout"
  failed_when: 
    - create_user_cmd.rc != 0
    - "'already registered' not in create_user_cmd.stdout"
    - "'already registered' not in create_user_cmd.stderr"
  tags: create_wp_user

- name: Mettre à jour les options de configuration du site
  shell: |
    docker-compose run --rm wpcli wp option update {{ item.key }} "{{ item.value }}"
  args:
    chdir: "{{ wordpress_project_dir }}"
  loop:
    - { key: 'blogname', value: "{{ wp_title }}" }
    - { key: 'home', value: "{{ wp_url }}" }
    - { key: 'siteurl', value: "{{ wp_url }}" }
  register: wp_options_update
  changed_when: 
    - "'Success' in wp_options_update.stdout"
    - "'unchanged' not in wp_options_update.stdout"
  tags: ['deploy', 'wordpress_install', 'config_update']

- name: Mettre à jour les données des utilisateurs WordPress
  shell: |
    TARGET_USER="{{ item.key }}"
    TARGET_PASS="{{ item.password }}"
    TARGET_EMAIL="{{ item.email }}"
    if docker-compose run --rm -T wpcli wp user check-password "$TARGET_USER" "$TARGET_PASS" > /dev/null 2>&1; then
        PASS_OK=1
    else
        PASS_OK=0
    fi
    CURRENT_EMAIL=$(docker-compose run --rm -T wpcli wp user get "$TARGET_USER" --field=user_email 2>/dev/null | tr -d '[:space:]')
    echo "DEBUG: User=$TARGET_USER | PassOK=$PASS_OK | CurrentEmail='$CURRENT_EMAIL' | TargetEmail='$TARGET_EMAIL'"
    if [ "$PASS_OK" -eq 0 ] || [ "$CURRENT_EMAIL" != "$TARGET_EMAIL" ]; then
        docker-compose run --rm -T wpcli wp user update "$TARGET_USER" --user_pass="$TARGET_PASS" --user_email="$TARGET_EMAIL" > /dev/null
        echo "UPDATE_DONE"
    else
        echo "NO_UPDATE"
    fi
  args:
    chdir: "{{ wordpress_project_dir }}"
    executable: /bin/bash
  loop:
    - { key: "{{ wp_admin_user }}", password: "{{ wp_admin_password }}", email: "{{ wp_admin_email }}" }
    - { key: "{{ wp_user }}", password: "{{ wp_user_password }}", email: "{{ wp_user_email }}" }
  register: users_wp_data_update
  changed_when: "'UPDATE_DONE' in users_wp_data_update.stdout"
  tags: ['deploy', 'wordpress_install', 'config_update']