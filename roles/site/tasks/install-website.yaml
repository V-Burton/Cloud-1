---
- name: Attendre que la base de données soit prête
  become: yes
  shell: >
    docker-compose exec -T db 
    mysqladmin ping -h localhost -u"{{ mysql_user }}" -p"{{ mysql_password }}" --silent
  args:
    chdir: "{{ wordpress_project_dir }}"
  register: db_check
  until: db_check.rc == 0
  retries: 24
  delay: 5
  changed_when: false

- name: Vérifier si WordPress est installé
  become: yes
  shell: docker-compose run --rm wpcli wp core is-installed
  args:
    chdir: "{{ wordpress_project_dir }}"
  register: wp_installed
  failed_when: false
  changed_when: false

- name: Installer le Core WordPress (si nécessaire)
  become: yes
  shell: |
    docker-compose run --rm wpcli wp core install \
      --url="{{ wp_url }}" \
      --title="{{ wp_title }}" \
      --admin_user="{{ wp_admin_user }}" \
      --admin_password="{{ wp_admin_password }}" \
      --admin_email="{{ wp_admin_email }}" \
      --skip-email
  args:
    chdir: "{{ wordpress_project_dir }}"
  when: wp_installed.rc != 0
  tags: install_core

- name: Créer l'utilisateur secondaire (si nécessaire)
  become: yes
  shell: |
    docker-compose run --rm wpcli wp user create \
      "{{ wp_user }}" "{{ wp_user_email }}" \
      --user_pass="{{ wp_user_password }}" \
      --role=editor
  args:
    chdir: "{{ wordpress_project_dir }}"
  register: create_user_cmd
  failed_when: 
    - create_user_cmd.rc != 0
    - "'already exists' not in create_user_cmd.stderr"
    - "'already exists' not in create_user_cmd.stdout"
  tags: create_wp_user